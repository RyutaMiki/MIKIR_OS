# Chocola ロードマップ

**方針**: 土台はアセンブリ（IPL + ローダ）、その上は **C でカーネル** を書く。

---

## 現在の構成

| レイヤ | ファイル | 言語 | 役割 |
|--------|----------|------|------|
| IPL | ipl.nas | asm | ブートセクタ。LBA でセクタ 1〜16 を 0x8000 に読み、ローダへジャンプ。 |
| ローダ | loader.nas | asm | GDT/A20/プロテクトモード移行、IDT 初期化、E820 メモリ検出、VESA モード設定、ISR スタブ → **kernel_main()** を呼ぶ。 |
| カーネル | kernel/kernel.c | **C** | シェル、VGA/VESA ドライバ、PIC/PIT、キーボード/マウス割り込み、ATA PIO ディスク I/O、メモリ管理、マルチタスク、GUI。約 900 行。 |
| FS ツール | mkfs.py | Python | ビルド時にディスクイメージへファイルを書き込む（暫定）。 |

ビルド: `make`（nasm, i686-elf-gcc, ld, objcopy, python3 が必要）
実行: `make run`（QEMU）

---

## フェーズ一覧

### Phase 1: ブートと C カーネル ✅

- IPL（ブートセクタ）+ ローダ（asm）でプロテクトモード移行。
- C の `kernel_main()` で VGA テキスト表示。

### Phase 2: シェル ✅

- キーボードポーリングによる文字入力。
- コマンドループ（`help`, `ver`, `echo`, `clear`）。
- プロンプト `C:\>` でコマンドを打てるコンソール。

### Phase 3-4: 割り込み ✅

- **PIC 初期化**: IRQ 0-7 を INT 0x20-0x27 にリマップ。
- **PIT タイマー**: 100Hz で tick カウント。`uptime` コマンド。
- **キーボード割り込み**: ポーリング → IRQ1 + リングバッファ + HLT（省電力）。
- **ISR スタブ**: asm で PUSHAD → C ハンドラ → EOI → IRET。

### Phase 5: ディスク読み取り + ファイル一覧 ✅

- **ATA PIO ドライバ**: IDE ディスクからセクタ単位で読み取り。
- **簡易ファイルシステム**: セクタ 100 にディレクトリ、セクタ 110〜にデータ。
- **コマンド**: `dir` / `ls`（ファイル一覧）、`type` / `cat`（ファイル表示）。
- **mkfs.py**: ビルド時にテストファイルを書き込み（暫定方式）。

---

### Phase 6: ディスク書き込み + ファイル操作 ✅

- ATA PIO 書き込み（`ata_write_sector`）、キャッシュフラッシュ。
- `write FILE` コマンド: テキスト入力 → ディスクに保存（最大 2KB）。
- `del FILE` コマンド: ファイル削除。
- 再起動してもファイルが残る（ディスクに永続化）。

---

### Phase 7: メモリ管理 ✅

- **E820 メモリマップ**: BIOS INT 15h で取得した物理メモリマップを表示（`mem` コマンド）。
- **ヒープ**: 0x200000 から 2MB。first-fit アロケータ、ブロック結合による断片化防止。
- **kmalloc / kfree**: 動的メモリ確保・解放。`memtest` コマンドで動作検証。

---

### Phase 8: マルチタスク ✅

- **プリエンプティブスケジューラ**: タイマー割り込み（100Hz）でラウンドロビン方式のコンテキストスイッチ。
- **タスク管理**: `task_create` でカーネルスレッド生成（最大 8 タスク）。
- **コマンド**: `ps`（タスク一覧）、`kill N`（タスク停止）。

---

### Phase 9: GUI（VESA グラフィック） ✅

- **VESA 640x480 256色**: バンクモード（64KB ウィンドウ）で描画。
- **描画プリミティブ**: ピクセル・矩形・文字（8x14 BIOS フォント）・テキスト。
- **デスクトップ**: 青い背景 + グレーのタスクバー + リアルタイム時計（HH:MM:SS）。
- **PS/2 マウス**: IRQ12 割り込みドライバ + 白い矢印カーソル。
- **タイマー ISR 駆動**: 時計・マウスカーソルの描画はタイマー割り込みハンドラ内で実行（シェルとの競合を排除）。
- **高速スクロール**: バンク最適化＋4バイト単位コピーによる高速スクロール。

---

### Phase 9.5: シェル強化 ✅

- **コマンド履歴**: 直近 16 件を保存、`history` コマンドで一覧表示。
- **矢印キー**: ↑↓ で履歴を呼び出し。

---

### Phase 10: FAT12 ファイルシステム ← 次はここ

| 目標 | 内容 |
|------|------|
| FAT12 読み取り | BPB 解析、FAT チェーン追跡、ルートディレクトリ解析。 |
| FAT12 書き込み | FAT テーブル更新、ディレクトリエントリ作成。 |
| 標準フォーマット | 他の OS（DOS/Windows）と互換のあるディスク形式。 |

**成果物**: Windows/Linux と互換のあるファイルシステムで動的にファイルを管理。

---

### Phase 11: ページング

| 目標 | 内容 |
|------|------|
| ページテーブル | CR3 設定、4KB ページのマッピング。 |
| 仮想メモリ | カーネル空間とユーザ空間の分離。 |
| ページフォルト | 不正アクセスのトラップ。 |

**成果物**: 仮想メモリによるメモリ保護の基盤。

---

### Phase 12: ウィンドウシステム

| 目標 | 内容 |
|------|------|
| ウィンドウ描画 | タイトルバー・枠・クライアント領域。 |
| ウィンドウ操作 | マウスでドラッグ移動・重ね合わせ。 |
| イベント配送 | クリック・キー入力をアクティブウィンドウへ配送。 |

**成果物**: マウスで操作できるウィンドウベースのデスクトップ。

---

## 技術スタック

| 項目 | 内容 |
|------|------|
| アセンブラ | NASM（elf32） |
| コンパイラ | i686-elf-gcc（-ffreestanding -O2） |
| リンカ | i686-elf-ld + link.ld |
| ビルド | Makefile → mikiros.img |
| 動作確認 | `qemu-system-i386 -boot order=c -drive file=mikiros.img,format=raw,if=ide` |

---

## メモリマップ

| アドレス | 用途 |
|----------|------|
| 0x00000 - 0x004FF | BIOS データ領域（フォントポインタ等） |
| 0x00500 - 0x00503 | E820 エントリ数 |
| 0x00504 - 0x006FF | E820 メモリマップデータ |
| 0x70000 - 0x70800 | IDT（256 エントリ × 8 バイト） |
| 0x7C000 - 0x7DFFF | IPL（ブートセクタ） |
| 0x80000 - 0x8FFFF | カーネル（IPL が読み込み） |
| 0x90000 ↓ | スタック（下方向に成長） |
| 0xA0000 - 0xAFFFF | VESA フレームバッファ（64KB バンクウィンドウ） |
| 0x200000 - 0x3FFFFF | ヒープ（2MB、kmalloc/kfree） |
