# Chocola ロードマップ

**方針**: 土台はアセンブリ（IPL + ローダ）、その上は **C でカーネル** を書く。

---

## 現在の構成

| レイヤ | ファイル | 言語 | 役割 |
|--------|----------|------|------|
| IPL | ipl.nas | asm | ブートセクタ。LBA でセクタ 1〜16 を 0x8000 に読み、ローダへジャンプ。 |
| ローダ | loader.nas | asm | GDT/A20/プロテクトモード移行、IDT 初期化、ISR スタブ → **kernel_main()** を呼ぶ。 |
| カーネル | kernel/kernel.c | **C** | シェル、VGA ドライバ、PIC/PIT、キーボード割り込み、ATA PIO ディスク読み取り。 |
| FS ツール | mkfs.py | Python | ビルド時にディスクイメージへファイルを書き込む（暫定）。 |

ビルド: `make`（nasm, i686-elf-gcc, ld, objcopy, python3 が必要）
実行: `make run`（QEMU）

---

## フェーズ一覧

### Phase 1: ブートと C カーネル ✅

- IPL（ブートセクタ）+ ローダ（asm）でプロテクトモード移行。
- C の `kernel_main()` で VGA テキスト表示。

### Phase 2: シェル ✅

- キーボードポーリングによる文字入力。
- コマンドループ（`help`, `ver`, `echo`, `clear`）。
- プロンプト `C:\>` でコマンドを打てるコンソール。

### Phase 3-4: 割り込み ✅

- **PIC 初期化**: IRQ 0-7 を INT 0x20-0x27 にリマップ。
- **PIT タイマー**: 100Hz で tick カウント。`uptime` コマンド。
- **キーボード割り込み**: ポーリング → IRQ1 + リングバッファ + HLT（省電力）。
- **ISR スタブ**: asm で PUSHAD → C ハンドラ → EOI → IRET。

### Phase 5: ディスク読み取り + ファイル一覧 ✅

- **ATA PIO ドライバ**: IDE ディスクからセクタ単位で読み取り。
- **簡易ファイルシステム**: セクタ 100 にディレクトリ、セクタ 110〜にデータ。
- **コマンド**: `dir` / `ls`（ファイル一覧）、`type` / `cat`（ファイル表示）。
- **mkfs.py**: ビルド時にテストファイルを書き込み（暫定方式）。

---

### Phase 6: ディスク書き込み + ファイル操作 ← 次はここ

| 目標 | 内容 |
|------|------|
| ATA PIO 書き込み | セクタ単位のディスク書き込み。 |
| ファイル作成 | OS 上から新しいファイルを作成・保存。 |
| ファイル削除 | 不要なファイルの削除。 |
| コマンド追加 | `write`, `del`, `rename` など。 |

**成果物**: `mkfs.py` なしで OS 上からファイルを自由に作成・削除できる。

---

### Phase 7: FAT12 ファイルシステム

| 目標 | 内容 |
|------|------|
| FAT12 読み取り | BPB 解析、FAT チェーン追跡、ルートディレクトリ解析。 |
| FAT12 書き込み | FAT テーブル更新、ディレクトリエントリ作成。 |
| 標準フォーマット | 他の OS（DOS/Windows）と互換のあるディスク形式。 |

**成果物**: 本物のファイルシステムで動的にファイルを管理。

---

### Phase 8: メモリ管理

| 目標 | 内容 |
|------|------|
| メモリマップ | BIOS から取得した使用可能領域の把握。 |
| 簡易 malloc/free | 動的メモリ確保・解放。 |
| ページング | 仮想メモリの基盤（CR3, ページテーブル）。 |

**成果物**: カーネル内で動的にメモリを確保できる。

---

### Phase 9: マルチタスク

| 目標 | 内容 |
|------|------|
| TSS 設定 | タスク状態セグメント。 |
| コンテキスト切り替え | タイマー割り込みでタスクを切り替え。 |
| プロセス管理 | プロセス生成・終了・スケジューリング。 |

**成果物**: 複数のプログラムを同時に実行できる。

---

### Phase 10: GUI（VGA グラフィック）

| 目標 | 内容 |
|------|------|
| VGA モード切替 | テキストモード → グラフィックモード (320x200 等)。 |
| 描画プリミティブ | 点・線・矩形・文字の描画。 |
| マウスドライバ | PS/2 マウス入力。 |
| ウィンドウシステム | シンプルなウィンドウの表示・移動。 |

**成果物**: マウスで操作できるグラフィカルなデスクトップ。

---

## 技術スタック

| 項目 | 内容 |
|------|------|
| アセンブラ | NASM（elf32） |
| コンパイラ | i686-elf-gcc（-ffreestanding） |
| リンカ | i686-elf-ld + link.ld |
| ビルド | Makefile → mikiros.img |
| 動作確認 | `qemu-system-i386 -boot order=c -drive file=mikiros.img,format=raw,if=ide` |

---

## メモリマップ

| アドレス | 用途 |
|----------|------|
| 0x00000 - 0x6FFFF | 空き（BIOS 領域含む） |
| 0x70000 - 0x70800 | IDT（256 エントリ × 8 バイト） |
| 0x7C000 - 0x7DFFF | IPL（ブートセクタ） |
| 0x80000 - 0x81FFF | カーネル（IPL が 16 セクタ読み込み） |
| 0x82000 - 0x8FFFF | 空き（将来のヒープ等） |
| 0x90000 ↓ | スタック（下方向に成長） |
| 0xB8000 | VGA テキストバッファ |
