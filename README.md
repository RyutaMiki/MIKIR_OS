# Chocola

BIOS ブートからカーネルまで全て自作した x86 OS です。
640x480 グラフィカルデスクトップ、マウス、マルチタスク、ファイル操作が動きます。

## これは何？

一般的な PC では、起動時に複数のソフトウェアが順番に実行されます。
Chocola では BIOS（QEMU 付属）以外の **全てを自作** しています。

```
┌────────┐    ┌────────────┐    ┌──────────────┐    ┌──────────────┐
│  BIOS  │ →  │  ipl.nas   │ →  │ loader.nas   │ →  │  kernel.c    │
│ (QEMU) │    │ ブート     │    │ 32bit 切替   │    │ シェル       │
│        │    │ ローダ     │    │ GDT/IDT/PIC  │    │ ドライバ     │
└────────┘    └────────────┘    └──────────────┘    └──────────────┘
  既製品        自作 ←──────────── 自作 ──────────────→ 自作
```

| 層 | 一般的な PC | Chocola |
|----|-----------|---------|
| ファームウェア | BIOS / UEFI | QEMU の SeaBIOS（既製品） |
| ブートローダ | GRUB / Windows Boot Manager | **ipl.nas**（自作） |
| OS ローダ | Linux の setup.bin 等 | **loader.nas**（自作） |
| カーネル | Linux kernel / NT kernel | **kernel.c**（自作） |

※ UEFI ではなく旧来の **BIOS ブート** 方式を採用しています。

## 機能

### グラフィック
- **VESA 640x480 256色** グラフィカルデスクトップ
- 青いデスクトップ背景 + グレーのタスクバー
- タスクバーにリアルタイム時計（HH:MM:SS）
- **PS/2 マウス** 対応（白い矢印カーソル）

### シェル
- `C:\>` プロンプトで 80列 × 32行のコンソール
- コマンド入力、バックスペース、スクロール対応
- コマンド履歴（↑↓ キーで呼び出し、`history` で一覧表示）

### コマンド一覧

| コマンド | 説明 |
|----------|------|
| `help` | コマンド一覧 |
| `ver` | バージョン表示 |
| `clear` | 画面クリア |
| `echo ..` | テキスト表示 |
| `uptime` | 起動時間（タイマー tick 数） |
| `history` | コマンド履歴の表示（↑↓ キーでも呼び出し可） |
| `dir` / `ls` | ディスク上のファイル一覧 |
| `type FILE` / `cat FILE` | ファイル内容を表示 |
| `write FILE` | テキスト入力 → ファイル作成 |
| `del FILE` | ファイル削除 |
| `mem` | メモリマップ + ヒープ状態 |
| `memtest` | malloc/free の動作テスト |
| `ps` | 実行中タスク一覧 |
| `kill N` | タスク N を停止 |

### OS 機能

| 機能 | 詳細 |
|------|------|
| 割り込み | PIC (8259) + PIT (100Hz タイマー) + キーボード IRQ1 + マウス IRQ12 |
| ディスク I/O | ATA PIO で IDE ディスク読み書き |
| ファイル操作 | 読み取り・作成・削除（再起動しても保持） |
| メモリ管理 | 2MB ヒープ、kmalloc/kfree（first-fit, ブロック結合） |
| マルチタスク | プリエンプティブ（タイマー割り込みでコンテキストスイッチ） |
| GUI | タイマー ISR 駆動（タスクバー時計 + マウスカーソルを割り込み内で描画） |
| グラフィック | VESA バンクモード、8x14 BIOS フォント、バンク最適化スクロール |

## ファイル構成

| ファイル | 言語 | 役割 |
|----------|------|------|
| ipl.nas | asm | ブートセクタ（512B）。LBA でカーネルを読み込み。 |
| loader.nas | asm | A20, GDT/IDT, E820 メモリ検出, フォント取得, VESA モード設定, 16→32bit 切替, ISR スタブ。 |
| kernel/kernel.c | C | カーネル本体（約 900 行）。シェル、ドライバ、タスク管理すべて。 |
| link.ld | - | リンカスクリプト（16bit/32bit セクションの VMA/LMA 分離）。 |
| mkfs.py | Python | ビルド時にテストファイルをディスクイメージへ書き込み。 |
| Makefile | - | ビルド・実行の自動化。 |

## 動かし方

### 1. 必要なツールを入れる（macOS）

```bash
brew install nasm qemu i686-elf-gcc
```

- **Apple Silicon (M1/M2/M4)**: `i686-elf-gcc` が必須
- Intel Mac: `gcc -m32` でも可（Makefile が自動判定）

### 2. ビルドと実行

```bash
cd MIKIR_OS
make        # mikiros.img を生成
make run    # QEMU で起動
```

### 3. 使い方

起動すると青いデスクトップに `C:\>` プロンプトが表示されます。

```
C:\>help              コマンド一覧
C:\>dir               ファイル一覧
C:\>type hello.txt    ファイル表示
C:\>write memo.txt    ファイル作成（空行で保存）
C:\>del memo.txt      ファイル削除
C:\>mem               メモリ情報
C:\>history           コマンド履歴
C:\>ps                タスク一覧
C:\>kill 1            タスク停止
C:\>uptime            起動時間
```

マウスは QEMU ウィンドウ内をクリックしてキャプチャ（解除: Ctrl+Alt+G）。
終了: QEMU ウィンドウを閉じる。

## アーキテクチャ

Chocola は **モノリシックカーネル** です。ドライバ、ファイルシステム、メモリ管理、タスク管理がすべてカーネル空間（`kernel.c`）に含まれています。

```
kernel.c（モノリシック構成）
├── VGA グラフィックドライバ
├── キーボード / マウスドライバ
├── ATA ディスクドライバ
├── ファイルシステム
├── メモリ管理（kmalloc / kfree）
├── タスク管理（ラウンドロビン・スケジューラ）
├── PIC / PIT 割り込み制御
├── GUI（タイマー ISR 駆動：時計・マウスカーソル）
└── シェル（コマンド履歴・矢印キー対応）
```

| | モノリシック（Chocola, Linux） | マイクロカーネル（MINIX, QNX） |
|---|---|---|
| 構造 | 全機能がカーネル内 | カーネルは最小限、ドライバは別プロセス |
| 速度 | 速い（関数呼び出し） | やや遅い（プロセス間通信） |
| 安定性 | ドライバのバグでカーネルごとクラッシュ | ドライバが落ちてもカーネルは生存 |

## ロードマップ

[ROADMAP.md](ROADMAP.md) を参照。
